{"name":"iot","slug":"iot","count":1,"posts":[{"title":"iotCore","slug":"iotCore","date":"2020-05-05T23:47:30.000Z","updated":"2020-11-23T01:31:25.288Z","comments":true,"pin":null,"path":"api/articles/iotCore.json","excerpt":"","keywords":null,"cover":"https://user-images.githubusercontent.com/62123161/81146079-8d8cff80-8fb2-11ea-9c70-659a95ce13a1.png","content":"<h2 id=\"개발환경-구축\"><a href=\"#개발환경-구축\" class=\"headerlink\" title=\"개발환경 구축\"></a>개발환경 구축</h2><p>※ 기본 개발환경</p>\n<ul>\n<li>IntelliJ</li>\n<li>Java, Spring</li>\n<li>AWS Console</li>\n</ul>\n<h2 id=\"IoT-Core-설명\"><a href=\"#IoT-Core-설명\" class=\"headerlink\" title=\"IoT Core 설명\"></a>IoT Core 설명</h2><ol>\n<li>AWS IoT Core는 커넥티드 디바이스가 쉽고 안전하게 클라우드 애플리케이션 및 다른 디바이스와 상호 작용할 수 있게 해주는 관리형 클라우드 서비스입니다. AWS IoT Core는 수십억 개의 디바이스와 수조 건의 메시지를 지원하며, 안전하고 안정적으로 이러한 메시지를 처리하여 AWS 엔드포인트 및 다른 디바이스로 라우팅할 수 있습니다. AWS IoT Core의 경우, 디바이스가 연결되어 있지 않더라도 언제나 애플리케이션에서 모든 디바이스를 추적하고 디바이스와 통신할 수 있습니다.</li>\n<li>또한 AWS IoT Core를 사용하면 인프라를 관리할 필요 없이, AWS Lambda, Amazon Kinesis, Amazon S3, Amazon SageMaker, Amazon DynamoDB, Amazon CloudWatch, AWS CloudTrail, Amazon QuickSight 및 Alexa Voice Service와 같은 AWS 및 Amazon 서비스를 사용하여, 커넥티드 디바이스에서 생성한 데이터를 수집, 처리 및 분석하고 이를 기반으로 운영하는 IoT 애플리케이션을 손쉽게 구축할 수 있습니다.</li>\n<li>현재 경동에서는 AWS IoT Core 플랫폼을 Converter쪽에서 주로 컨트롤 하고 있다.(자세한 설명은 생략한다..) </li>\n</ol>\n<p><a href=\"https://user-images.githubusercontent.com/62123161/81146079-8d8cff80-8fb2-11ea-9c70-659a95ce13a1.png\" target=\"_blank\" rel=\"noopener\"><img src=\"https://user-images.githubusercontent.com/62123161/81146079-8d8cff80-8fb2-11ea-9c70-659a95ce13a1.png\" alt=\"iotcore_01\"></a><br><em>초기화면 - 전체 디바이스에 대한 현황을 보여준다.</em></p>\n<ul>\n<li>기존 다른 서비스와 다른 점으로는 하나의 플랫폼이 모든 서비스의 디바이스를 관리한다는 점. (서비스별로 그룹화 불가능 / 물론, Additional Value로 값을 지정할 수는 있음.)</li>\n<li>경동은 Manage, Secure, Act, Test 네가지 속성만을 사용한다. (Setting은 무시 ㅡㅡ;)</li>\n</ul>\n<h3 id=\"1-Manage\"><a href=\"#1-Manage\" class=\"headerlink\" title=\"1) Manage\"></a>1) Manage</h3><h4 id=\"Things\"><a href=\"#Things\" class=\"headerlink\" title=\"Things\"></a>Things</h4><p><a href=\"https://user-images.githubusercontent.com/62123161/81146081-8e259600-8fb2-11ea-91dc-6815331e657f.png\" target=\"_blank\" rel=\"noopener\"><img src=\"https://user-images.githubusercontent.com/62123161/81146081-8e259600-8fb2-11ea-91dc-6815331e657f.png\" alt=\"iotcore_02\"></a></p>\n<ul>\n<li>Things는 디바이스 전체가 나오는 화면 / 검색을 통하여 특정 디바이스를 찾을 수 있으며, 연결이 됬는지 안됬는지 확인할 수 있다.(명령어 예-  connectivity.connected:true)</li>\n</ul>\n<h4 id=\"Type\"><a href=\"#Type\" class=\"headerlink\" title=\"Type\"></a>Type</h4><p><a href=\"https://user-images.githubusercontent.com/62123161/81146082-8e259600-8fb2-11ea-9f1f-1b7b523a9f28.png\" target=\"_blank\" rel=\"noopener\"><img src=\"https://user-images.githubusercontent.com/62123161/81146082-8e259600-8fb2-11ea-9f1f-1b7b523a9f28.png\" alt=\"iotcore_03\"></a></p>\n<ul>\n<li>디바이스 별로 Section을 구분할 수 없기에 Type으로 지정할 수 있다.</li>\n</ul>\n<h4 id=\"Thing-groups\"><a href=\"#Thing-groups\" class=\"headerlink\" title=\"Thing groups\"></a>Thing groups</h4><p><a href=\"https://user-images.githubusercontent.com/62123161/81146071-8b2aa580-8fb2-11ea-9dee-0fff15dabd08.png\" target=\"_blank\" rel=\"noopener\"><img src=\"https://user-images.githubusercontent.com/62123161/81146071-8b2aa580-8fb2-11ea-9dee-0fff15dabd08.png\" alt=\"iotcore_04\"></a></p>\n<ul>\n<li>현재는 스마트톡 밖에 없지만, 향후 서비스별로 추가가 될 예정이다.</li>\n</ul>\n<h4 id=\"Secure\"><a href=\"#Secure\" class=\"headerlink\" title=\"Secure\"></a>Secure</h4><h5 id=\"Certificates\"><a href=\"#Certificates\" class=\"headerlink\" title=\"Certificates\"></a>Certificates</h5><p><a href=\"https://user-images.githubusercontent.com/62123161/81146073-8c5bd280-8fb2-11ea-992d-b30143ac216c.png\" target=\"_blank\" rel=\"noopener\"><img src=\"https://user-images.githubusercontent.com/62123161/81146073-8c5bd280-8fb2-11ea-992d-b30143ac216c.png\" alt=\"iotcore_05\"></a></p>\n<ul>\n<li>IoT Core의 꽃이다. 인증서는 각 디바이스별로 갖고있으며, 인증서가 있어야만 Things에 등록될 수 있다.</li>\n<li>반대로 얘기하면 인증서가 없이는 어떤 디바이스라도(실제 우리제품이라고 하더라도) 등록이 안된다는 소리이며</li>\n<li>이 얘기를 조금 더 풀어 해석한다면, 관리가 철저해야 한다는 것이다. 인증서 잃어버리는 순간 모든 디바이스가 접속불가 상태가 발생할 수 있다.</li>\n</ul>\n<h5 id=\"Policies\"><a href=\"#Policies\" class=\"headerlink\" title=\"Policies\"></a>Policies</h5><p><a href=\"https://user-images.githubusercontent.com/62123161/81146074-8c5bd280-8fb2-11ea-8f0c-f8c31f10cd69.png\" target=\"_blank\" rel=\"noopener\"><img src=\"https://user-images.githubusercontent.com/62123161/81146074-8c5bd280-8fb2-11ea-8f0c-f8c31f10cd69.png\" alt=\"iotcore_06\"></a></p>\n<ul>\n<li>정책이다. 화면 하단의 Json처럼 접근에 대한 권한을 지정할 수 있다. 아직 IAM 권한에 대해 완벽하게 공부하지 않아서, 연습때문에 모든 권한을 풀어둔 상태다. 나중에는 수정해야한다.</li>\n<li>정책에서 연결된 인증서 관리도 가능하다. </li>\n<li>(인증서-정책)은 하나의 쌍이다. 둘 중 하나라도 없으면 서비스가 돌아가지 않는다.</li>\n</ul>\n<h4 id=\"Act\"><a href=\"#Act\" class=\"headerlink\" title=\"Act\"></a>Act</h4><h5 id=\"Rules\"><a href=\"#Rules\" class=\"headerlink\" title=\"Rules\"></a>Rules</h5><p><a href=\"https://user-images.githubusercontent.com/62123161/81146075-8cf46900-8fb2-11ea-89a0-1b77f260ecba.png\" target=\"_blank\" rel=\"noopener\"><img src=\"https://user-images.githubusercontent.com/62123161/81146075-8cf46900-8fb2-11ea-89a0-1b77f260ecba.png\" alt=\"iotcore_07\"></a></p>\n<ul>\n<li>위에서 디바이스쪽의 꽃이 인증서였다면, 서버쪽의 꽃은 바로 이 Rule Engine이다.</li>\n<li>기본 Rule은 쿼리 시스템으로 움직인다. MQTT 기준 Topic주제를 통해서 들어오는 데이터는 모두 Rule Engine을 거친다고 보면된다.</li>\n<li>따라서, 디바이스에서 보내는 신호를 어떻게 처리할지 마음대로 정해줄 수 있다. (INPUT / OUTPUT 데이터 모두 컨트롤이 가능하다.)</li>\n</ul>\n<h4 id=\"Test\"><a href=\"#Test\" class=\"headerlink\" title=\"Test\"></a>Test</h4><p><a href=\"https://user-images.githubusercontent.com/62123161/81146077-8cf46900-8fb2-11ea-87f0-60331ea24adb.png\" target=\"_blank\" rel=\"noopener\"><img src=\"https://user-images.githubusercontent.com/62123161/81146077-8cf46900-8fb2-11ea-87f0-60331ea24adb.png\" alt=\"iotcore_08\"></a></p>\n<ul>\n<li>직접 써보기 바란다. 더 이상의 설명은 생략함.</li>\n<li>힌트 : MQTT라고 써져있듯이 Topic을 통한 Pub/Sub 구조임. Topic을 Sub한 상태로 아래 Pub에 데이터를 싣어서 보내면 수신함.(뭔가 다 알려준거같은데…. 그래도모르면 질문….)</li>\n</ul>\n<h3 id=\"2-소스\"><a href=\"#2-소스\" class=\"headerlink\" title=\"2) 소스\"></a>2) 소스</h3><ul>\n<li>100줄도 안된다. (기타 자체 참조가 좀 들어가있지만, 그냥 보고 쓰기엔 나쁘지 않을 것이다.)</li>\n<li>그리고, 당연한 얘기지만 IoT Core는 Full Managing System이다. 따라서, Create Things만 있다.<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"BASH\"><figure class=\"iseeu highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LambdaLogger logger = context.getLogger();</span><br><span class=\"line\">ResponseCreateThings responseCreateThings = new ResponseCreateThings();</span><br><span class=\"line\">try&#123;</span><br><span class=\"line\">    logger.log(<span class=\"string\">\"Start CreateThings\"</span>);</span><br><span class=\"line\">    SecretManagerHelper.getInstance();</span><br><span class=\"line\"> </span><br><span class=\"line\">    String queryString = String.format(<span class=\"string\">\"thingName:roomcon-%s\"</span>, request.macAddress);</span><br><span class=\"line\">    GetStatisticsRequest getStatisticsRequest = new GetStatisticsRequest().withQueryString(queryString);</span><br><span class=\"line\">    GetStatisticsResult result = AWSIoTHelper.getInstance().getAWSIot().getStatistics(getStatisticsRequest);</span><br><span class=\"line\"> </span><br><span class=\"line\">    Map&lt;String, String&gt; attributes = new HashMap&lt;String, String&gt;();</span><br><span class=\"line\">    attributes.put(<span class=\"string\">\"ADDITIONAL_VALUE\"</span>, request.additionalValue);</span><br><span class=\"line\">    attributes.put(<span class=\"string\">\"THINGS_TYPE\"</span>, request.thingsType);</span><br><span class=\"line\">    AttributePayload attributePayload = new AttributePayload().withAttributes(attributes);//.addAttributesEntry(<span class=\"string\">\"ADDITIONAL_VALUE\"</span>, request.additionalValue);</span><br><span class=\"line\"> </span><br><span class=\"line\">    String thingName = String.format(<span class=\"string\">\"roomcon-%s\"</span>, request.macAddress);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(result.getStatistics().getCount() == 0)&#123;</span><br><span class=\"line\">        String groupName = <span class=\"string\">\"etc\"</span>;</span><br><span class=\"line\">        String secureArn = Config.IOT_CORE_NODE.path(<span class=\"string\">\"IOT_CORE_SECURE_1ST_ARN\"</span>).asText();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(request.thingsType.equals(<span class=\"string\">\"001\"</span>))&#123;</span><br><span class=\"line\">            groupName = <span class=\"string\">\"nr-30d\"</span>;</span><br><span class=\"line\">            secureArn = Config.IOT_CORE_NODE.path(<span class=\"string\">\"IOT_CORE_SECURE_1ST_ARN\"</span>).asText();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(request.thingsType.equals(<span class=\"string\">\"002\"</span>))&#123;</span><br><span class=\"line\">            groupName = <span class=\"string\">\"nr-35d\"</span>;</span><br><span class=\"line\">            secureArn = Config.IOT_CORE_NODE.path(<span class=\"string\">\"IOT_CORE_SECURE_2ND_ARN\"</span>).asText();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(request.thingsType.equals(<span class=\"string\">\"003\"</span>))&#123;</span><br><span class=\"line\">            groupName = <span class=\"string\">\"nr-40d\"</span>;</span><br><span class=\"line\">            secureArn = Config.IOT_CORE_NODE.path(<span class=\"string\">\"IOT_CORE_SECURE_2ND_ARN\"</span>).asText();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(request.thingsType.equals(<span class=\"string\">\"011\"</span>))&#123;</span><br><span class=\"line\">            groupName = <span class=\"string\">\"nrm-35d\"</span>;</span><br><span class=\"line\">            secureArn = Config.IOT_CORE_NODE.path(<span class=\"string\">\"IOT_CORE_SECURE_2ND_ARN\"</span>).asText();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">        CreateThingRequest createThingRequest = new CreateThingRequest()</span><br><span class=\"line\">                .withThingName(thingName)</span><br><span class=\"line\">                .withAttributePayload(attributePayload)</span><br><span class=\"line\">                .withThingTypeName(<span class=\"string\">\"RoomController\"</span>);</span><br><span class=\"line\">        CreateThingResult createThingResult = AWSIoTHelper.getInstance().getAWSIot().createThing(createThingRequest);</span><br><span class=\"line\"> </span><br><span class=\"line\">        AddThingToThingGroupRequest addThingToThingGroupRequest = new AddThingToThingGroupRequest()</span><br><span class=\"line\">                .withThingArn(Config.IOT_CORE_NODE.path(<span class=\"string\">\"IOT_CORE_THINGS_ARN\"</span>).asText() + thingName)</span><br><span class=\"line\">                .withThingGroupArn(Config.IOT_CORE_NODE.path(<span class=\"string\">\"IOT_CORE_GROUP_ARN\"</span>).asText() + groupName)</span><br><span class=\"line\">                .withThingGroupName(groupName)</span><br><span class=\"line\">                .withThingName(thingName);</span><br><span class=\"line\">        AddThingToThingGroupResult addThingToThingGroupResult = AWSIoTHelper.getInstance().getAWSIot().addThingToThingGroup(addThingToThingGroupRequest);</span><br><span class=\"line\"> </span><br><span class=\"line\">        AttachThingPrincipalRequest attachThingPrincipalRequest = new AttachThingPrincipalRequest()</span><br><span class=\"line\">                .withThingName(thingName)</span><br><span class=\"line\">                .withPrincipal(secureArn);</span><br><span class=\"line\">        AttachThingPrincipalResult attachThingPrincipalResult = AWSIoTHelper.getInstance().getAWSIot().attachThingPrincipal(attachThingPrincipalRequest);</span><br><span class=\"line\"> </span><br><span class=\"line\">        responseCreateThings.isSuccess = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        responseCreateThings.successCode = 201;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        UpdateThingRequest updateThingRequest = new UpdateThingRequest()</span><br><span class=\"line\">                .withThingName(thingName)</span><br><span class=\"line\">                .withAttributePayload(attributePayload);</span><br><span class=\"line\">        UpdateThingResult updateThingResult = AWSIoTHelper.getInstance().getAWSIot().updateThing(updateThingRequest);</span><br><span class=\"line\"> </span><br><span class=\"line\">        responseCreateThings.isSuccess = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        responseCreateThings.successCode = 200;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; catch(Throwable e) &#123;</span><br><span class=\"line\">    logger.log(<span class=\"string\">\"Error CreateThings\"</span>);</span><br><span class=\"line\">    responseCreateThings.isSuccess = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    responseCreateThings.successCode = 500;</span><br><span class=\"line\">&#125; finally &#123;</span><br><span class=\"line\">    logger.log(<span class=\"string\">\"End CreateThings\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">return</span> responseCreateThings;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></div>\n</li>\n</ul>\n","text":"개발환경 구축※ 기본 개발환경IntelliJJava, SpringAWS ConsoleIoT Core 설명AWS IoT Core는 커넥티드 디바이스가 쉽고 안전하게 클라우드 애플리케이션 및 다른 디바이스와 상호 작용할 수 있게 해주는 관리형 클라우드 서","link":"","raw":null,"photos":[],"categories":[{"name":"aws","slug":"aws","count":18,"path":"api/categories/aws.json"}],"tags":[{"name":"AWS","slug":"AWS","count":20,"path":"api/tags/AWS.json"},{"name":"iot","slug":"iot","count":1,"path":"api/tags/iot.json"},{"name":"IoT Core","slug":"IoT-Core","count":1,"path":"api/tags/IoT-Core.json"}]}]}